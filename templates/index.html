<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>App de prédiction immobilière - Prototype</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Estimation DVF</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link active" href="#">Prédiction</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="container">
      <div class="row">
        <div class="col-md-7">
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">Formulaire d'estimation</h5>
              <p class="text-muted">Remplissez quelques informations pour obtenir une estimation rapide.</p>

              <form id="form" onsubmit="return false;">
                <div class="mb-3">
                  <label for="commune" class="form-label">Commune</label>
                  <input id="commune" class="form-control" placeholder="Ex: Paris" />
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="surface" class="form-label">Surface (m²)</label>
                    <input id="surface" class="form-control" placeholder="Ex: 45" type="number" min="0" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="rooms" class="form-label">Pièces</label>
                    <input id="rooms" class="form-control" placeholder="Ex: 2" type="number" min="0" />
                  </div>
                </div>

                <button id="predict" class="btn btn-primary">Obtenir une estimation</button>
              </form>
              <hr />
              <div>
                <label for="tokenInput" class="form-label">Jeton API (à demander)</label>
                <div class="input-group mb-3">
                  <input id="tokenInput" class="form-control" placeholder="Collez votre token ici" />
                  <button id="saveToken" class="btn btn-outline-secondary" type="button">Enregistrer</button>
                  <button id="clearToken" class="btn btn-outline-secondary" type="button">Effacer</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-5">
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">Résultat</h5>
              <div id="result">Aucun résultat pour l'instant.</div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      async function callPredictPublic(payload){
        const res = await fetch('/predict-public', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error('Erreur réseau: ' + res.status);
        return res.json();
      }

      // Token helpers
      const tokenInput = document.getElementById('tokenInput');
      const saveTokenBtn = document.getElementById('saveToken');
      const clearTokenBtn = document.getElementById('clearToken');

      function getSavedToken(){ return localStorage.getItem('api_token') || ''; }
      function setSavedToken(t){ localStorage.setItem('api_token', t); }
      function clearSavedToken(){ localStorage.removeItem('api_token'); }

      // Initialize token input from storage
      tokenInput.value = getSavedToken();

      saveTokenBtn.addEventListener('click', ()=>{ setSavedToken(tokenInput.value.trim()); alert('Token enregistré dans le navigateur'); });
      clearTokenBtn.addEventListener('click', ()=>{ clearSavedToken(); tokenInput.value=''; alert('Token effacé'); });

      document.getElementById('predict').addEventListener('click', async (e)=>{
        e.preventDefault();
        const commune = document.getElementById('commune').value;
        const surface = document.getElementById('surface').value;
        const rooms = document.getElementById('rooms').value;
        const out = document.getElementById('result');
        out.textContent = 'Calcul en cours...';
        try{
          const payload = { commune, surface, rooms };
          // Decide: call protected /predict with token if available, otherwise call public /predict-public
          const token = getSavedToken();
          let data;
          if(token){
            const res = await fetch('/predict', { method:'POST', headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify(payload) });
            if(!res.ok) throw new Error('Erreur API: ' + res.status);
            data = await res.json();
          } else {
            // No token: call the protected route will fail; instead we still call /predict to show behavior
            const res = await fetch('/predict', { method:'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
            if(!res.ok){
              const txt = await res.text();
              throw new Error('API non autorisée: ' + res.status + ' - ' + txt);
            }
            data = await res.json();
          }
          out.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }catch(err){
          out.textContent = 'Erreur: ' + err.message;
        }
      });
    </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>