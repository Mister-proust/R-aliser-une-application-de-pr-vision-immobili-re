<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>App de prédiction immobilière - Prototype</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Estimation DVF</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link active" href="#">Prédiction</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="container">
      <div class="row">
        <div class="col-md-7">
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">Formulaire d'estimation</h5>
              <p class="text-muted">Remplissez quelques informations pour obtenir une estimation rapide.</p>

              <form id="form" onsubmit="return false;">
                <div class="mb-3">
                  <label for="commune" class="form-label">Commune (nom) ou code INSEE</label>
                  <input id="commune" class="form-control" placeholder="Ex: Paris ou 75056" />
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="type_voie" class="form-label">Type de voie</label>
                    <select id="type_voie" class="form-select">
                      <option value="">(Chargement...)</option>
                    </select>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="type_local" class="form-label">Type local</label>
                    <select id="type_local" class="form-select">
                      <option value="">(Chargement...)</option>
                    </select>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="surface_terrain" class="form-label">Surface terrain (m²)</label>
                      <input id="surface_terrain" class="form-control" placeholder="Ex: 0" type="number" min="0" step="any" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="surface_reelle_bati" class="form-label">Surface reelle bati (m²)</label>
                    <input id="surface_reelle_bati" class="form-control" placeholder="Ex: 45" type="number" min="0" step="any" />
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="nombre_pieces_principales" class="form-label">Nombre pieces principales</label>
                    <input id="nombre_pieces_principales" class="form-control" placeholder="Ex: 2" type="number" min="0" />
                  </div>
                </div>

                <button id="predict" class="btn btn-primary">Obtenir une estimation</button>
              </form>
              <hr />
              <div>
                <label for="tokenInput" class="form-label">Jeton API (à demander)</label>
                <div class="input-group mb-3">
                  <input id="tokenInput" class="form-control" placeholder="Collez votre token ici" />
                  <button id="saveToken" class="btn btn-outline-secondary" type="button">Enregistrer</button>
                  <button id="clearToken" class="btn btn-outline-secondary" type="button">Effacer</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-5">
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">Résultat</h5>
              <div id="result">Aucun résultat pour l'instant.</div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      async function callPredictPublic(payload){
        const res = await fetch('/predict-public', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error('Erreur réseau: ' + res.status);
        return res.json();
      }

      // Token helpers
          const tokenInput = document.getElementById('tokenInput');
      const saveTokenBtn = document.getElementById('saveToken');
      const clearTokenBtn = document.getElementById('clearToken');

      // Populate selects on load
      async function populateSelects(){
        try{
          const res = await fetch('/meta/options');
          if(!res.ok) return;
          const data = await res.json();
          const tv = document.getElementById('type_voie');
          const tl = document.getElementById('type_local');
          tv.innerHTML = '';
          tl.innerHTML = '';
          const addOpt = (el, v) => { const o = document.createElement('option'); o.value = v; o.text = v; el.appendChild(o); };
          addOpt(tv, '');
          addOpt(tl, '');
          (data.type_voie || []).forEach(v => addOpt(tv, v));
          (data.type_local || []).forEach(v => addOpt(tl, v));
        }catch(e){
          // ignore fail
        }
      }
      populateSelects();

      function getSavedToken(){ return localStorage.getItem('api_token') || ''; }
      function setSavedToken(t){ localStorage.setItem('api_token', t); }
      function clearSavedToken(){ localStorage.removeItem('api_token'); }

      // Initialize token input from storage
      tokenInput.value = getSavedToken();

      saveTokenBtn.addEventListener('click', ()=>{ setSavedToken(tokenInput.value.trim()); alert('Token enregistré dans le navigateur'); });
      clearTokenBtn.addEventListener('click', ()=>{ clearSavedToken(); tokenInput.value=''; alert('Token effacé'); });

      document.getElementById('predict').addEventListener('click', async (e)=>{
        e.preventDefault();
        const out = document.getElementById('result');
        out.textContent = 'Calcul en cours...';
        try{
          // Helper to read and coerce numeric inputs (returns string or number)
          function readNumber(id){
            const el = document.getElementById(id);
            if(!el) return null;
            const v = el.value;
            if(v === null || v === undefined || v === "") return null;
            const n = Number(v);
            return Number.isFinite(n) ? n : null;
          }

          // Build payload with property-level fields only. Backend will enrich using communes CSV and encoders.
          const payload = {};
          // commune may be name or code_insee
          const communeVal = document.getElementById('commune').value;
          // If commune looks numeric and length matches INSEE (5), send as code_insee
          const possibleCode = communeVal ? communeVal.trim() : '';
          if(possibleCode && /^\d{5}$/.test(possibleCode)){
            payload['code_insee'] = possibleCode;
          } else {
            payload['commune'] = possibleCode;
          }
          payload['type_voie'] = (document.getElementById('type_voie').value || '').trim();
          payload['type_local'] = (document.getElementById('type_local').value || '').trim();
          payload['surface_terrain'] = readNumber('surface_terrain');
          payload['surface_reelle_bati'] = readNumber('surface_reelle_bati');
          payload['nombre_pieces_principales'] = readNumber('nombre_pieces_principales');

          // Decide which endpoint: /predict requires token
          const token = getSavedToken();
          const headers = { 'Content-Type': 'application/json' };
          if(token) headers['Authorization'] = 'Bearer ' + token;

          const res = await fetch('/predict', { method: 'POST', headers, body: JSON.stringify(payload) });
          if(!res.ok){
            const txt = await res.text();
            throw new Error('API error ' + res.status + ': ' + txt);
          }
          const data = await res.json();
          // Preferred output: highlight the estimated_price
          if(data && (data.estimated_price || (data.result && data.result.estimated_price))){
            const price = data.estimated_price ?? (data.result && data.result.estimated_price);
            out.innerHTML = `<div class="text-center"><h2 style="font-size:2.2rem; font-weight:700;">${Number(price).toLocaleString('fr-FR')} €</h2><div class="text-muted small mt-2">Estimation</div></div>`;
          } else if(data && data.result && data.result.estimated_price){
            const price = data.result.estimated_price;
            out.innerHTML = `<div class="text-center"><h2 style="font-size:2.2rem; font-weight:700;">${Number(price).toLocaleString('fr-FR')} €</h2><div class="text-muted small mt-2">Estimation (fallback)</div></div>`;
          } else {
            out.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
          }
        }catch(err){
          out.textContent = 'Erreur: ' + err.message;
        }
      });
    </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>