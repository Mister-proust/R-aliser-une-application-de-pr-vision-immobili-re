<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>App de prédiction immobilière - Prototype</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Estimation DVF</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link active" href="#">Prédiction</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="container">
      <div class="row">
        <div class="col-md-7">
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">Formulaire d'estimation</h5>
              <p class="text-muted">Remplissez quelques informations pour obtenir une estimation rapide.</p>

              <form id="form" onsubmit="return false;">
                <div class="mb-3">
                  <label for="type_voie_encodee" class="form-label">Type de voie (encode)</label>
                  <input id="type_voie_encodee" class="form-control" placeholder="Ex: 1" type="number" />
                </div>

                <div class="mb-3">
                  <label for="type_local_encodee" class="form-label">Type local (encode)</label>
                  <input id="type_local_encodee" class="form-control" placeholder="Ex: 1" type="number" />
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="Surface terrain" class="form-label">Surface terrain (m²)</label>
                    <input id="Surface terrain" class="form-control" placeholder="Ex: 0" type="number" min="0" step="any" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="Surface reelle bati" class="form-label">Surface reelle bati (m²)</label>
                    <input id="Surface reelle bati" class="form-control" placeholder="Ex: 45" type="number" min="0" step="any" />
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="Nombre pieces principales" class="form-label">Nombre pieces principales</label>
                    <input id="Nombre pieces principales" class="form-control" placeholder="Ex: 2" type="number" min="0" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="densite" class="form-label">Densite</label>
                    <input id="densite" class="form-control" placeholder="Ex: 1000" type="number" min="0" step="any" />
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="population" class="form-label">Population</label>
                    <input id="population" class="form-control" placeholder="Ex: 50000" type="number" min="0" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="superficie_km2" class="form-label">Superficie (km²)</label>
                    <input id="superficie_km2" class="form-control" placeholder="Ex: 10.5" type="number" min="0" step="any" />
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="Valeur fonciere" class="form-label">Valeur fonciere (EUR) - Si inconnu mettez 0</label>
                    <input id="Valeur fonciere" class="form-control" placeholder="Ex: 120000" type="number" min="0" step="any" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="altitude_moyenne" class="form-label">Altitude moyenne (m)</label>
                    <input id="altitude_moyenne" class="form-control" placeholder="Ex: 35" type="number" step="any" />
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="latitude_centre" class="form-label">Latitude centre</label>
                    <input id="latitude_centre" class="form-control" placeholder="Ex: 48.8566" type="number" step="any" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="longitude_centre" class="form-label">Longitude centre</label>
                    <input id="longitude_centre" class="form-control" placeholder="Ex: 2.3522" type="number" step="any" />
                  </div>
                </div>

                <button id="predict" class="btn btn-primary">Obtenir une estimation</button>
              </form>
              <hr />
              <div>
                <label for="tokenInput" class="form-label">Jeton API (à demander)</label>
                <div class="input-group mb-3">
                  <input id="tokenInput" class="form-control" placeholder="Collez votre token ici" />
                  <button id="saveToken" class="btn btn-outline-secondary" type="button">Enregistrer</button>
                  <button id="clearToken" class="btn btn-outline-secondary" type="button">Effacer</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-5">
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">Résultat</h5>
              <div id="result">Aucun résultat pour l'instant.</div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      async function callPredictPublic(payload){
        const res = await fetch('/predict-public', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error('Erreur réseau: ' + res.status);
        return res.json();
      }

      // Token helpers
      const tokenInput = document.getElementById('tokenInput');
      const saveTokenBtn = document.getElementById('saveToken');
      const clearTokenBtn = document.getElementById('clearToken');

      function getSavedToken(){ return localStorage.getItem('api_token') || ''; }
      function setSavedToken(t){ localStorage.setItem('api_token', t); }
      function clearSavedToken(){ localStorage.removeItem('api_token'); }

      // Initialize token input from storage
      tokenInput.value = getSavedToken();

      saveTokenBtn.addEventListener('click', ()=>{ setSavedToken(tokenInput.value.trim()); alert('Token enregistré dans le navigateur'); });
      clearTokenBtn.addEventListener('click', ()=>{ clearSavedToken(); tokenInput.value=''; alert('Token effacé'); });

      document.getElementById('predict').addEventListener('click', async (e)=>{
        e.preventDefault();
        const out = document.getElementById('result');
        out.textContent = 'Calcul en cours...';
        try{
          // list of exact column names expected by the model
          const columns = ["type_voie_encodee", "type_local_encodee", "Surface terrain", "Surface reelle bati", "Nombre pieces principales", "densite", "population", "superficie_km2", "Valeur fonciere", "altitude_moyenne", "latitude_centre", "longitude_centre"];

          // Helper to read and coerce numeric inputs (returns number or null)
          function readNumber(id){
            const el = document.getElementById(id);
            if(!el) return null;
            const v = el.value;
            if(v === null || v === undefined || v === "") return null;
            const n = Number(v);
            return Number.isFinite(n) ? n : null;
          }

          // Build payload using exact keys
          const payload = {};
          // Numeric fields
          payload["type_voie_encodee"] = readNumber('type_voie_encodee') ?? 0;
          payload["type_local_encodee"] = readNumber('type_local_encodee') ?? 0;
          payload["Surface terrain"] = readNumber('Surface terrain') ?? 0;
          payload["Surface reelle bati"] = readNumber('Surface reelle bati') ?? 0;
          payload["Nombre pieces principales"] = readNumber('Nombre pieces principales') ?? 0;
          payload["densite"] = readNumber('densite') ?? 0;
          payload["population"] = readNumber('population') ?? 0;
          payload["superficie_km2"] = readNumber('superficie_km2') ?? 0;
          payload["Valeur fonciere"] = readNumber('Valeur fonciere') ?? 0;
          payload["altitude_moyenne"] = readNumber('altitude_moyenne') ?? 0;
          payload["latitude_centre"] = readNumber('latitude_centre') ?? 0;
          payload["longitude_centre"] = readNumber('longitude_centre') ?? 0;

          // Decide which endpoint: /predict requires token
          const token = getSavedToken();
          const headers = { 'Content-Type': 'application/json' };
          if(token) headers['Authorization'] = 'Bearer ' + token;

          const res = await fetch('/predict', { method: 'POST', headers, body: JSON.stringify(payload) });
          if(!res.ok){
            const txt = await res.text();
            throw new Error('API error ' + res.status + ': ' + txt);
          }
          const data = await res.json();
          out.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }catch(err){
          out.textContent = 'Erreur: ' + err.message;
        }
      });
    </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>